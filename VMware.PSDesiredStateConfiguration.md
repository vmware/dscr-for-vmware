## Getting Started

**VMware.PSDesiredStateConfiguration** provides commands to compile and execute **DSC Configuration** without using the DSC Local Configuration Manager. Compiled configuration is stored in memory as PS Object. Set, Get, Test-... cmdlets use Invoke-DSCResource cmdlet of PSDesiredStateConfiguration module to execute/run/process the compiled configuration. This solution allows cross platform support on MacOS and Linux. This module is also designed to work with the existing **DSC Resources** in **VMware.vSphereDSC**.

## Requirements

The following table describes the required dependencies for running VMware.vSphereDSC Resources.

 **Required dependency**   | **Minimum version**
-------------------------- | -------------------
`PowerShell`               | 5.1 or 7.0

This module also has additional requirements depending on which version of PowerShell you wish to use it with.

#### PowerShell 7.0 requirements
---
**VMware.PSDesiredStateConfiguration** uses the **Invoke-DscResource** cmdlet from **PSDesiredStateConfiguration** module to process individual DSC Resources. In **PowerShell 7.0** the **Invoke-DscResource** cmdlet is a experimental feature.
The Invoke-DscResource cmdlet and it must be enabled with the following command.
```
Enable-ExperimentalFeature PSDesiredStateConfiguration.InvokeDscResource
```
 After executing the command you must restart your powershell session. The command needs to be run only once and the cmdlet will be usable.
 To check if the Invoke-DscResource cmdlet has been enabled correctly run the following command
```
Get-Module 'PSDesiredStateConfiguration' -ListAvailable | Select-Object -ExpandProperty ExportedCommands
```
##### Important!
When using **PowerShell 7.0** please keep in mind the list of [Known Limitations](https://github.com/vmware/dscr-for-vmware/blob/master/LIMITATIONS.md)

---
#### PowerShell 5.1 requirements
For **PowerShell 5.1** you need to enable Windows Remote Management
For information on how to enable it read here: [WinRM guide](https://docs.microsoft.com/en-us/windows/win32/winrm/installation-and-configuration-for-windows-remote-management)


## Installations

### Manual Installation

1. Copy the VMware.PSDesiredStateConfiguration Module to one of the system PowerShell module directories. For more information on installing PowerShell Modules, please visit [Installing a PowerShell Module](https://docs.microsoft.com/en-us/powershell/scripting/developer/module/installing-a-powershell-module?view=powershell-7).
2. In PowerShell import the VMware.PSDesiredStateConfiguration Module:
   ```
    Import-Module -Name 'VMware.PSDesiredStateConfiguration'
   ```

   To check if the module was successfully installed:
   ```
    Get-Module -Name 'VMware.PSDesiredStateConfiguration'
   ```

## Use Overview
VMware.PSDesiredStateConfiguration works with ps1 configuration files and the general flow is as follow:
- Compile ps1 DSC configuration and transforms given configuration to a configuration object. The object contains the name of the configuration and an array of sorted DSC Resource by dependencies. Each Resource contains **InstanceName** for name of the resource given in the configuration, **ResourceType** which display the type of resource,  **ModuleName** which displays the module of the resource, **Property** which is a hashtable of properties which are unique to the given resource. Example Configuration object from a given configuration:
    ```
    Configuration Test
    {
        Import-DscResource -ModuleName MyDscResource

        CustomResource myResource
        {
            Field = "Test field"
            Ensure = "Present"
        }
    }

    # configuration object result
    [VmwDscConfiguration]@{
        InstanceName = 'Test'
        Resource = @(
            [VmwDscResource]@{
                InstanceName = 'myResource'
                ResourceType = 'CustomResource'
                ModuleName = 'MyDscResource'
                Property = @{
                    Field = "Test field"
                    Ensure = "Present"
                }
            }
        )
    }
    ```
    Note: this step does not require the use of **LCM** and does not generate a **MOF** file.
- The resulting configuration object generated by the **New-VmwDscConfiguration** cmdlet gets used with the Start, Get, Test cmdlets and the result is based on the cmdlet.

## Cmdlet Guide
#### New-VmwDscConfiguration
This cmdlet creates a VmwDscConfiguration object which contains information about the configuration. This object is then used with the other cmdlets in order to perform the three main DSC operations(GET, SET, TEST).

##### Parameters
- **ConfigName** - Name of the Configuration to be compied as string
- **CustomParams** - Represents a hashtable of parameters that are used for the Configuration.
- **ConfigurationData** - Hashtable of values that are to be used as variables during the configuration execution
---
#### Start,Test,Get-VmwDscConfiguration
These cmdlets work with the PowerShell object created by **New-VmwDscConfiguration** and apply the Set, Test, Get **DSC methods** to the compiled configuration.

##### Parameters
- **Configuration** - A Dsc Configuration compiled by **New-VmwDscConfiguration**

---
### Examples

##### Example with [VMHostNtpSettings Resource](https://github.com/vmware/dscr-for-vmware/wiki/VMHostNtpSettings) from vSphereDsc module

1. Use the following vSphereDsc Configuration
    ```
    Configuration VMHostNtpSettings_Config {
        Import-DscResource -ModuleName VMware.vSphereDSC
    
        $Password = $Password | ConvertTo-SecureString -AsPlainText -Force
        $Credential = New-Object System.Management.Automation.PSCredential($User, $Password)
    
        VMHostNtpSettings vmHostNtpSettings {
            Name = $Name
            Server = $Server
            Credential = $Credential
            NtpServer = @("0.bg.pool.ntp.org", "1.bg.pool.ntp.org", "2.bg.pool.ntp.org")
            NtpServicePolicy = "automatic"
        }
    }
    ```

2. You need to compile the Configuration to a PowerShell object
    ```
    $compilationArgs = @{
        ConfigName = VMHostNtpSettings
        CustomParams = @{
            Name = '<VMHost Name>'
            Server 'Server Name>'
            Password '<Password for User>'
        }
    }

    $dscConfiguration = New-VmwDscConfiguration @compilationArgs
    ```
3. To Test if the NTP Settings are in the desired state:
    ```
    Test-VmwDscConfiguration -Configuration $dscConfiguration 
    ```
4. To Apply the NTP Configuration:
    ```
    Start-VmwDscConfiguration -Configuration $dscConfiguration
    ```
5. To get the latest applied configuration on your machine:
    ```
    Get-VmwDscConfiguration -Configuration $dscConfiguration
    ```